apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "node-local-cache.fullname" . }}-node
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "node-local-cache.labels" . | nindent 4 }}
    app.kubernetes.io/component: node
spec:
  selector:
    matchLabels:
      {{- include "node-local-cache.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: node
  template:
    metadata:
      labels:
        {{- include "node-local-cache.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: node
    spec:
      serviceAccountName: {{ include "node-local-cache.serviceAccountName" . }}
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      hostNetwork: false
      containers:
        - name: node-local-cache
          image: "{{ .Values.image.repository }}:{{ include "node-local-cache.imageTag" . }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          args:
            - --mode=node
            - --csi-socket=/csi/csi.sock
            - --base-path={{ .Values.csi.basePath }}
            - --log-level={{ .Values.csi.logLevel }}
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          securityContext:
            privileged: true
          volumeMounts:
            - name: socket-dir
              mountPath: /csi
            - name: cache-dir
              mountPath: {{ .Values.csi.basePath }}
              mountPropagation: Bidirectional
            - name: pods-mount-dir
              mountPath: /var/lib/kubelet/pods
              mountPropagation: Bidirectional
            - name: plugins-dir
              mountPath: /var/lib/kubelet/plugins
              mountPropagation: Bidirectional
          resources:
            {{- toYaml .Values.node.resources | nindent 12 }}

        - name: csi-node-driver-registrar
          image: {{ .Values.sidecars.registrar.image }}
          args:
            - --csi-address=/csi/csi.sock
            - --kubelet-registration-path=/var/lib/kubelet/plugins/{{ include "node-local-cache.driverName" . }}/csi.sock
          volumeMounts:
            - name: socket-dir
              mountPath: /csi
            - name: registration-dir
              mountPath: /registration
          resources:
            {{- toYaml .Values.sidecars.registrar.resources | nindent 12 }}

      volumes:
        - name: socket-dir
          hostPath:
            path: /var/lib/kubelet/plugins/{{ include "node-local-cache.driverName" . }}
            type: DirectoryOrCreate
        - name: cache-dir
          hostPath:
            path: {{ .Values.csi.basePath }}
            type: DirectoryOrCreate
        - name: pods-mount-dir
          hostPath:
            path: /var/lib/kubelet/pods
            type: Directory
        - name: plugins-dir
          hostPath:
            path: /var/lib/kubelet/plugins
            type: Directory
        - name: registration-dir
          hostPath:
            path: /var/lib/kubelet/plugins_registry
            type: Directory

      {{- with .Values.node.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.node.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
